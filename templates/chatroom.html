<!-- http://127.0.0.1:8000/chatroom (èŠå¤©å®¤) -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>èŠå¤©å®¤</title>

    <!-- Firebase SDK v9 -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>

    <!--  å…¨åŸŸæ¨£å¼èˆ‡ Reset -->
    <style>
        :root {
            --navbar-height: 60px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Noto Sans TC", "Segoe UI", sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 0 0;
        }
        h1, h2 {
            color: #ffffff;
            background-color: #494747; /* æ·ºç°è‰²èƒŒæ™¯ï¼Œå¯ä¾éœ€æ±‚ä¿®æ”¹ */
        }
        p {
            font-size: 1.1em;
            color: #444;
            margin-bottom: 10px;
        }
    </style>

    <!-- å°è¦½åˆ—æ¨£å¼ -->
    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
        }

        .navbar .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar a {
            text-decoration: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-links a:hover {
            color: #4CAF50;
        }
    </style>

    <!-- å…§å®¹å€åŸŸæ¨£å¼ -->
    <style>
        .content {
            margin-top: calc(var(--navbar-height) + 0px);
            padding: 0px 0px;
            position: relative;
            background: radial-gradient(circle at center, #eaffea 0%, #ffffff 100%);
            overflow: hidden;
        }

        .main-content {
            position: relative;
            z-index: 1;
        }
    </style>

    <!-- å‹•æ…‹èƒŒæ™¯åœ“å½¢ -->
    <style>
        .circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }

        .circle.green {
            background-color: #A5D6A7;
        }

        .circle.white {
            background-color: #F1F8E9;
        }

        .circle1 {
            width: 120px;
            height: 120px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .circle2 {
            width: 200px;
            height: 200px;
            top: 60%;
            left: 70%;
            animation-delay: 2s;
        }

        .circle3 {
            width: 80px;
            height: 80px;
            top: 40%;
            left: 50%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(360deg);
            }
        }
    </style>

    <!-- èŠå¤©å®¤å¤–è§€ -->
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--navbar-height)); /* é™¤æ‰å°èˆªåˆ—é«˜åº¦ */
            width: 100%;
            background: #f8f9fa;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(to bottom, #e8f5e9, #ffffff);
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            position: relative; /* ç‚ºå…§éƒ¨çµ•å°å®šä½æŒ‰éˆ•æä¾›åƒè€ƒ */
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .username {
            font-size: 0.85rem;
            font-weight: bold;
            color: #388e3c;
            margin-bottom: 3px;
        }

        .chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            word-wrap: break-word;
            position: relative; /* æ–°å¢é€™è¡Œ */
        }
        
        .bubble-actions {
            position: absolute;
            right: -50px; /* è² å€¼è®“æŒ‰éˆ•å‡ºç¾åœ¨æ°£æ³¡å³é‚Šå¤–é¢ */
            bottom: 5px;
        }

        .bubble-actions button {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 6px;
            cursor: pointer;
        }

        .chat-message.own {
            flex-direction: row-reverse;
        }

        .chat-message.own .chat-bubble {
            background: #4caf50;
            color: white;
        }

        .chat-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #13a818; /* ç¶ è‰²åº•ï¼Œè®“è¼¸å…¥å€æ›´æ¸…æ¥š */
        }

        .chat-input input[type="text"] {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
        }

        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
        }

        .chat-input button {
            padding: 10px 16px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
        }

        .chat-input button:hover {
            opacity: 0.9;
        }

        .reply-button{
            color: #555;
            font-size: 0.9em; 
            margin-bottom: 5px;
        }

        .chat-time {
            font-size: 0.75rem;
            color: gray;
            margin-top: 3px;
            text-align: right;
        }

        .video {
            max-width: 100%;
            border-radius: 10px;
        }
        .ai-message {
            padding: 5px;
            margin: 3px;
            background-color: #dff6ff;
            border-radius: 5px;
            font-style: italic;
            text-align: left;
        }

    </style>
    
    <!--è¡¨æƒ…ç¬¦è™Ÿå¤–è§€-->
    <style>
        .reaction-btn {
            display: none;
            position: absolute;
            bottom: 5px;
            right: -10px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 18px;
        }

        .chat-bubble:hover .reaction-btn {
            display: inline;
        }

        .reaction-display {
            position: absolute;
            bottom: 30px;
            right: -35px;
            font-size: 14px;
        }
    </style>
    <!-- é è¦½å€å¤–è§€ -->
    <style>
        .preview-area {
            border: 1px solid #000000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 20px;
            background: #bafb75;
            display: none; /* é è¨­éš±è— */
            transition: all 0.3s ease; /* å¹³æ»‘é¡¯ç¤º */
            margin-left: 15px;        /* å·¦é‚Šç•™ç™½ */

            max-width: 50%;       /* åªä½”ç•«é¢ä¸€åŠå¯¬ */
            align-self: flex-start; /* é å·¦ï¼Œå¯æ”¹æˆ flex-end è®“å³é‚Š */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .preview-area img,
        .preview-area video {
            max-width: 200px;
            margin: 5px;
            border-radius: 8px;
        }
        .preview-area p {
            margin: 5px 0;
            font-size: 14px;
            word-wrap: break-word; /* æ–‡å­—éé•·æ›è¡Œ */
        }
    </style>

    <!--æ´»å‹•è¡¨å–®å¤–è§€-->
    <style>
        .event-form {
            margin: 10px 0;
            padding: 12px;
            background: #fff8e1;
            border: 1px solid #ffe58f;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 14px;
        }

        .event-form input,
        .event-form textarea {
            padding: 8px 10px;
            border: 1px solid #ffd666;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            transition: border 0.2s;
        }
        .event-form input:focus,
        .event-form textarea:focus {
            border-color: #faad14;
        }

        /* === æ´»å‹•è¨Šæ¯æ°£æ³¡ === */
        .event-bubble {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 14px;
            padding: 12px 14px;
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
            max-width: 90%;   /* ä¸è¦ä½”æ»¿ç•«é¢ï¼Œåƒå°è©±æ¡† */
            min-width: 300px; /* é¿å…å¤ªçª„ */
            word-wrap: break-word;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        /* æ´»å‹•æ¨™é¡Œ */
        .event-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 6px;
            color: #d48806;
        }

        /* æ´»å‹•è³‡è¨Šï¼ˆæ—¥æœŸ/æ™‚é–“/åœ°é»ï¼‰ */
        .event-info {
            font-size: 14px;
            margin-bottom: 6px;
            color: #444;
        }

        /* åƒåŠ äººæ•¸ */
        .event-participants {
            font-size: 13px;
            margin-top: 5px;
            color: #555;
        }

        /* === æŒ‰éˆ•æ¨£å¼ === */
        .event-join-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: #52c41a;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s, transform 0.1s;
        }
        .event-join-btn:hover:not(:disabled) {
            background: #389e0d;
        }
        .event-join-btn:active:not(:disabled) {
            transform: scale(0.96);
        }
        .event-join-btn:disabled {
            background: #b7eb8f;
            cursor: not-allowed;
            color: #333;
        }
    </style>

</head>
<body>
    <div class="navbar">
        <div class="logo">ç¶²çƒåŠ©æ‰‹</div>
        <div class="nav-links">
            <a href="index">é¦–é </a>
            <a href="rules">è¦å‰‡è§£èªª</a>
            <a href="score">è¨˜åˆ†æ¿</a>
            <a href="videos">å½±ç‰‡è§£èªª</a>
            <a href="wall_training">å°ç‰†ç·´ç¿’</a>
            <a href="serve_practice">ç™¼çƒç·´ç¿’</a>
            <a href="swing_practice">æ®æ‹ç·´ç¿’</a>
            <a href="throwing_practice">æ‹‹çƒç·´ç¿’</a>
            <a href="chatroom">èŠå¤©å®¤</a>
        </div>
    </div>

    <!-- èŠå¤©å®¤ -->
    <div class="content">
        <div class="chat-container">
            <h2>èŠå¤©å®¤</h2>
            <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
            <div id="chat-messages" class="chat-messages"></div>

            <!-- é è¦½å€ -->
            <div id="preview" class="preview-area"></div>
            <div id="replyNotice" class="reply-button"></div>
            <!-- è¼¸å…¥å€ -->
            <div class="chat-input">
                
                <textarea id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1"></textarea>
                <input type="file" id="imageInput" accept="image/*" style="display:none" />
                <input type="file" id="videoInput" accept="video/*" style="display:none" />
                <button id="createEventBtn">æ´»å‹•</button>
                <button id="uploadImageBtn">picture</button>
                <button id="uploadVideoBtn">video</button>
                <button id="aiBtn">AI</button>
                <button id="sendBtn">é€å‡º</button>

                <!-- æ´»å‹•è¼¸å…¥è¡¨å–® (é è¨­éš±è—) -->
                <div id="eventForm" class="event-form" style="display:none;">
                    <input type="text" id="eventDate" placeholder="æ—¥æœŸ (MM/DD)">
                    <input type="text" id="eventTime" placeholder="æ™‚é–“ (HH:MM)">
                    <input type="text" id="eventLocation" placeholder="åœ°é»">
                    <button id="sendEventBtn">ç™¼ä½ˆæ´»å‹•</button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded,update,onChildRemoved, onChildChanged, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

        // === Firebase é…ç½® ===
        const firebaseConfig = {
            apiKey: "AIzaSyCZIUNh1YUTlFo7p81a7pLxM6woYkmwlZo",
            authDomain: "tennis-system.firebaseapp.com",
            databaseURL: "https://tennis-system-default-rtdb.firebaseio.com",
            projectId: "tennis-system",
            storageBucket: "tennis-system.firebasestorage.app",
            messagingSenderId: "894451128494",
            appId: "1:894451128494:web:ac40a3c44006c35532753f",
            measurementId: "G-KGCHWBEGM2"
        };

        // === åˆå§‹åŒ– ===
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const messagesDiv = document.getElementById('chat-messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        let replyTargetKey = null;  // å­˜æ”¾ç•¶å‰å›è¦†çš„è¨Šæ¯ key
        const replyNotice = document.getElementById('replyNotice');  // é¡¯ç¤ºå›è¦†å°è±¡
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const uploadVideoBtn = document.getElementById('uploadVideoBtn');
        const imageInput = document.getElementById('imageInput');
        const videoInput = document.getElementById('videoInput');
        const previewDiv = document.getElementById('preview');
        //æ´»å‹•ç›¸é—œ
        const createEventBtn = document.getElementById('createEventBtn');
        const eventForm = document.getElementById('eventForm');
        const sendEventBtn = document.getElementById('sendEventBtn');
        const eventDate = document.getElementById('eventDate');
        const eventTime = document.getElementById('eventTime');
        const eventLocation = document.getElementById('eventLocation');
        //AI
        const aiBtn = document.getElementById('aiBtn'); 

        const messagesRef = ref(db, 'chatroom/messages');

        // === ç›£è½è¨Šæ¯ ===
        onChildAdded(messagesRef, (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;

            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';
            msgEl.dataset.key = key;

            const avatar = document.createElement('img');
            avatar.className = 'avatar';
            avatar.src = data.avatar || '/static/default-avatar.png';

            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';

            const usernameEl = document.createElement('div');
            usernameEl.className = 'username';
            usernameEl.textContent = data.user;

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            // è»Ÿåˆªé™¤éæ¿¾
            if (!data || data.deleted) return;

            // åˆ¤æ–·è¨Šæ¯é¡å‹ï¼Œçµ¦ä¸åŒ class æ¨£å¼(aièˆ‡äºº)
            if (data.type === "ai") {
                msgEl.classList.add("ai-message");
            }

            // å»ºç«‹å›è¦†æŒ‰éˆ•å€å¡Š
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'bubble-actions';
            const replyBtn = document.createElement('button');

            actionsDiv.appendChild(replyBtn);
            bubble.appendChild(actionsDiv);

            // === æ´»å‹•è¨Šæ¯ ===
            if (data.type === "event") {
                bubble.classList.add("event-bubble");

                const title = document.createElement('div');
                title.className = "event-title";
                title.textContent = "ğŸ¾ ç¶²çƒæ´»å‹•é‚€è«‹";

                const info = document.createElement('div');
                info.className = "event-info";
                info.innerHTML = `
                    ğŸ“… æ—¥æœŸ: ${data.date}<br>
                    ğŸ•’ æ™‚é–“: ${data.time}<br>
                    ğŸ“ åœ°é»: ${data.location}
                `;

                const participants = document.createElement('div');
                participants.className = "event-participants";
                participants.textContent = `ç›®å‰åƒåŠ äººæ•¸: ${data.participants || 0}`;

                const joinBtn = document.createElement('button');
                joinBtn.className = "event-join-btn";
                joinBtn.textContent = "åƒåŠ ";

                joinBtn.addEventListener('click', () => {
                    const newCount = (data.participants || 0) + 1;
                    update(ref(db, `chatroom/messages/${key}`), { participants: newCount });
                    participants.textContent = `ç›®å‰åƒåŠ äººæ•¸: ${newCount}`;
                    joinBtn.disabled = true;
                });

                bubble.appendChild(title);
                bubble.appendChild(info);
                bubble.appendChild(participants);
                bubble.appendChild(joinBtn);
            }

            // === æ–‡å­— ===
            if (data.text) {
                if (data.type !== "event") {
                    const textEl = document.createElement('p');
                    textEl.innerHTML = data.text.replace(/\n/g, '<br>');
                    bubble.appendChild(textEl);
                }
            }

            // === åœ–ç‰‡ ===
            if (data.imageUrl) {
                const imgEl = document.createElement('img');
                imgEl.src = data.imageUrl;
                imgEl.className = 'upload-preview';
                imgEl.onclick = () => window.open(data.imageUrl, "_blank");

                // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•— â†’ è‡ªå‹•åˆªæ‰è©²è¨Šæ¯
                imgEl.onerror = async () => {
                    console.warn("åœ–ç‰‡ä¸å­˜åœ¨ï¼Œå·²ç§»é™¤:", data.imageUrl);
                    msgEl.remove();
                    try {
                        await update(ref(db, `chatroom/messages/${key}`), { deleted: true });
                    } catch (err) {
                        console.error("åˆªé™¤ Firebase è¨Šæ¯å¤±æ•—:", err);
                    }
                };

                // é™åˆ¶åœ–ç‰‡å¤§å°
                imgEl.onload = () => {
                    if (imgEl.naturalWidth > 400 || imgEl.naturalHeight > 400) {
                        imgEl.style.maxWidth = "400px";
                        imgEl.style.maxHeight = "400px";
                        imgEl.style.objectFit = "contain";
                    }
                };

                bubble.appendChild(imgEl);
            }

            // === å½±ç‰‡ ===
            if (data.videoUrl) {
                const videoEl = document.createElement('video');
                videoEl.src = data.videoUrl;
                videoEl.controls = true;
                videoEl.preload = "metadata";
                videoEl.style.maxHeight = "300px";

                // å¦‚æœå½±ç‰‡è¼‰å…¥å¤±æ•— â†’ è‡ªå‹•åˆªæ‰è©²è¨Šæ¯
                videoEl.onerror = async () => {
                    console.warn("å½±ç‰‡ä¸å­˜åœ¨ï¼Œå·²ç§»é™¤:", data.videoUrl);
                    msgEl.remove();
                    try {
                        await update(ref(db, `chatroom/messages/${key}`), { deleted: true });
                    } catch (err) {
                        console.error("åˆªé™¤ Firebase è¨Šæ¯å¤±æ•—:", err);
                    }
                };

                bubble.appendChild(videoEl);
            }

            // === å›è¦†æŒ‰éˆ• ===
            replyBtn.className = 'reply-btn';
            replyBtn.textContent = 'å›è¦†';
            replyBtn.addEventListener('click', () => {
                replyTargetKey = key;  // è¨˜éŒ„è¦å›è¦†çš„è¨Šæ¯ key
                messageInput.focus();
            });
            actionsDiv.appendChild(replyBtn);
            bubble.appendChild(actionsDiv);

            // === è¡¨æƒ…ç¬¦è™ŸåŠŸèƒ½ ===
            const reactionBtn = document.createElement('button');
            reactionBtn.className = 'reaction-btn';
            reactionBtn.textContent = 'ğŸ‘';

            reactionBtn.addEventListener('click', () => {
                const currentReactions = data.reactions || {};
                const newCount = (currentReactions['ğŸ‘'] || 0) + 1;
                update(ref(db, `chatroom/messages/${key}`), {
                    reactions: { ...currentReactions, 'ğŸ‘': newCount }
                });
            });

            const reactionDisplay = document.createElement('div');
            reactionDisplay.className = 'reaction-display';
            if (data.reactions) {
                reactionDisplay.textContent = Object.entries(data.reactions)
                    .map(([emoji, count]) => `${emoji} ${count}`)
                    .join(' ');
            }

            bubble.appendChild(reactionBtn);
            bubble.appendChild(reactionDisplay);


            // === é¡¯ç¤ºå›è¦†å…§å®¹ (å¦‚æœè¨Šæ¯æ˜¯å›è¦†åˆ¥äººçš„) ===
            if (data.replyTo) {
                const parentEl = messagesDiv.querySelector(`[data-key="${data.replyTo}"]`);
                if (parentEl) {
                    const replyEl = document.createElement('div');
                    replyEl.className = 'reply-preview';
                    replyEl.textContent = `å›è¦† ${parentEl.querySelector('.username').textContent}`;
                    bubble.insertBefore(replyEl, bubble.firstChild);
                }
            }

            const timeEl = document.createElement('div');
            timeEl.className = 'chat-time';
            timeEl.textContent = new Date(data.timestamp).toLocaleTimeString();

            bubble.appendChild(timeEl);
            contentEl.appendChild(usernameEl);
            contentEl.appendChild(bubble);
            msgEl.appendChild(avatar);
            msgEl.appendChild(contentEl);

            messagesDiv.appendChild(msgEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // === ç›£è½åˆªé™¤ ===
        onChildRemoved(messagesRef, (snapshot) => {
            const key = snapshot.key;
            const msgEl = messagesDiv.querySelector(`[data-key="${key}"]`);
            if (msgEl) msgEl.remove();
        });

        // === ç›£è½è¨Šæ¯æ›´æ–° (è¡¨æƒ…ç¬¦è™Ÿç­‰) ===
        onChildChanged(messagesRef, (snapshot) => {
            const key = snapshot.key;
            const data = snapshot.val();

            // æ‰¾åˆ°è©²è¨Šæ¯ DOM
            const msgEl = messagesDiv.querySelector(`[data-key="${key}"]`);
            if (!msgEl) return;

            // æ‰¾åˆ° reactionDisplay
            const reactionDisplay = msgEl.querySelector('.reaction-display');
            if (!reactionDisplay) return;

            // æ›´æ–° reactions é¡¯ç¤º
            if (data.reactions) {
                reactionDisplay.textContent = Object.entries(data.reactions)
                    .map(([emoji, count]) => `${emoji} ${count}`)
                    .join(' ');
            } else {
                reactionDisplay.textContent = '';
            }
        });

        // === ç™¼é€æ–‡å­— ===
        sendBtn.addEventListener('click', () => sendPost());
        //=== ç¶å®š AI æŒ‰éˆ• ===
        aiBtn.addEventListener('click', () => sendAIMessage()); 
        // === ç™¼é€ä¸€å‰‡è²¼æ–‡ ===
        async function sendPost() {
            const text = messageInput.value.trim();
            const imageFile = imageInput.files[0];
            const videoFile = videoInput.files[0];
            
            let imageUrl = null;
            let videoUrl = null;

            // ä¸Šå‚³åœ–ç‰‡
            if (imageFile) {
                const imgPath = `chat_images/${Date.now()}_${imageFile.name}`;
                const imgRef = storageRef(storage, imgPath);

                const { progressBar, progressText } = showUploadProgress("åœ–ç‰‡");
                const uploadTask = uploadBytesResumable(imgRef, imageFile);

                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `æ­£åœ¨ä¸Šå‚³åœ–ç‰‡... ${progress.toFixed(0)}%`;
                        },
                        reject,
                        async () => {
                            imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                            resolve();
                        }
                    );
                });
            }

            // ä¸Šå‚³å½±ç‰‡
            if (videoFile) {
                const vidPath = `chat_videos/${Date.now()}_${videoFile.name}`;
                const vidRef = storageRef(storage, vidPath);

                const { progressBar, progressText } = showUploadProgress("å½±ç‰‡");
                const uploadTask = uploadBytesResumable(vidRef, videoFile);

                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `æ­£åœ¨ä¸Šå‚³å½±ç‰‡... ${progress.toFixed(0)}%`;
                        },
                        reject,
                        async () => {
                            videoUrl = await getDownloadURL(uploadTask.snapshot.ref);
                            resolve();
                        }
                    );
                });
            }

            // push è²¼æ–‡
            push(messagesRef, {
                user: "ç®¡ç†å“¡",
                text: text || null,
                imageUrl: imageUrl || null,
                videoUrl: videoUrl || null,
                replyTo: replyTargetKey || null, // æ–°å¢å›è¦†æ¬„ä½
                type: "user",
                timestamp: Date.now()
            });

            // æ¸…ç©ºè¼¸å…¥æ¡†
            messageInput.value = '';
            imageInput.value = '';
            videoInput.value = '';
            previewDiv.innerHTML = ''; 
            replyTargetKey = null;
            replyNotice.textContent = '';
        }

        // === ç™¼é€ä¸€å‰‡è²¼æ–‡çµ¦AI  ===
        async function sendAIMessage() {
            const text = messageInput.value.trim();
            if (!text) return alert("è«‹å…ˆè¼¸å…¥è¦å• AI çš„å…§å®¹ï¼");

            // å…ˆæ¨é€æ€è€ƒä¸­è¨Šæ¯ï¼Œä¸¦ä¿å­˜ reference
            let thinkingMessageRef = null;
            try {
                thinkingMessageRef = await push(messagesRef, {
                    user: "AI åŠ©æ‰‹",
                    text: "ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...",
                    type: "ai",
                    timestamp: Date.now()
                });
                console.log("æ€è€ƒè¨Šæ¯å·²æ¨é€");
            } catch (error) {
                console.error("æ¨é€æ€è€ƒè¨Šæ¯å¤±æ•—:", error);
                alert("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                return;
            }

            try {
                console.log("æ­£åœ¨å‘¼å« AI API...");
                
                // å‘¼å«å¾Œç«¯ /chatgpt API
                const res = await fetch("/chatgpt", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: text })
                });

                console.log("API å›æ‡‰ç‹€æ…‹:", res.status);

                if (!res.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${res.status}`);
                }

                const data = await res.json();
                console.log("AI API å›æ‡‰è³‡æ–™:", data);

                // è™•ç†å›æ‡‰è³‡æ–™
                let aiReply = '';

                if (data.error) {
                    // API è¿”å›éŒ¯èª¤ï¼ˆå¦‚é…é¡è¶…é™ï¼‰
                    aiReply = data.error;
                    console.warn("AI API éŒ¯èª¤:", data.error_type || 'unknown', data.error);
                } else if (data.reply && typeof data.reply === 'string' && data.reply.trim()) {
                    // æ­£å¸¸å›æ‡‰
                    aiReply = data.reply.trim();
                } else {
                    // å›æ‡‰æ ¼å¼ç•°å¸¸æˆ–ç©ºå›æ‡‰
                    aiReply = "æŠ±æ­‰ï¼ŒAI åŠ©ç†ç›®å‰ç„¡æ³•æ­£å¸¸å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                    console.warn("AI å›æ‡‰æ ¼å¼ç•°å¸¸:", data);
                }

                // é›™é‡æª¢æŸ¥ç¢ºä¿å›æ‡‰ä¸ç‚ºç©º
                if (!aiReply || aiReply === '' || aiReply === 'undefined') {
                    aiReply = "æŠ±æ­‰ï¼Œæˆ‘æš«æ™‚ç„¡æ³•å›æ‡‰æ‚¨çš„å•é¡Œã€‚";
                }

                console.log("è™•ç†å¾Œçš„ AI å›æ‡‰:", aiReply);

                // åˆªé™¤æ€è€ƒä¸­è¨Šæ¯
                if (thinkingMessageRef && thinkingMessageRef.key) {
                    try {
                        await update(ref(db, `chatroom/messages/${thinkingMessageRef.key}`), {
                            deleted: true
                        });
                        console.log("æ€è€ƒè¨Šæ¯å·²åˆªé™¤");
                    } catch (deleteError) {
                        console.error("åˆªé™¤æ€è€ƒè¨Šæ¯å¤±æ•—:", deleteError);
                    }
                }

                // æ¨é€ AI å›æ‡‰
                const aiMessageData = {
                    user: "AI åŠ©æ‰‹",
                    text: aiReply,
                    type: "ai",
                    timestamp: Date.now()
                };

                console.log("æº–å‚™æ¨é€ AI è¨Šæ¯:", aiMessageData);

                await push(messagesRef, aiMessageData);
                console.log("AI è¨Šæ¯æ¨é€æˆåŠŸ");

            } catch (error) {
                console.error("AI API éŒ¯èª¤:", error);

                // åˆªé™¤æ€è€ƒä¸­è¨Šæ¯
                if (thinkingMessageRef && thinkingMessageRef.key) {
                    try {
                        await update(ref(db, `chatroom/messages/${thinkingMessageRef.key}`), {
                            deleted: true
                        });
                    } catch (deleteError) {
                        console.error("åˆªé™¤æ€è€ƒè¨Šæ¯å¤±æ•—:", deleteError);
                    }
                }

                // æ¨é€éŒ¯èª¤è¨Šæ¯
                try {
                    await push(messagesRef, {
                        user: "AI åŠ©æ‰‹",
                        text: "âŒ æŠ±æ­‰ï¼ŒAI æœå‹™æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
                        type: "ai",
                        timestamp: Date.now()
                    });
                    console.log("éŒ¯èª¤è¨Šæ¯æ¨é€æˆåŠŸ");
                } catch (pushError) {
                    console.error("æ¨é€éŒ¯èª¤è¨Šæ¯å¤±æ•—:", pushError);
                    alert("AI æœå‹™ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            }

            // æ¸…ç©ºè¼¸å…¥æ¡†
            messageInput.value = '';
            updatePreview();
        }
        
        // --- ç›£è½ Enter / Shift+Enter ---
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // é˜»æ­¢æ›è¡Œ
                sendPost();         // é€å‡ºè¨Šæ¯
            }
        });

        // === é¡¯ç¤ºä¸Šå‚³é€²åº¦è¨Šæ¯ ===
        function showUploadProgress(fileType) {
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message';

            const avatar = document.createElement('img');
            avatar.className = 'avatar';
            avatar.src = '/static/default-avatar.png';

            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';

            const usernameEl = document.createElement('div');
            usernameEl.className = 'username';
            usernameEl.textContent = "ç®¡ç†å“¡";

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            // é€²åº¦æ–‡å­—
            const progressText = document.createElement('div');
            progressText.textContent = `æ­£åœ¨ä¸Šå‚³ ${fileType}... 0%`;
            progressText.style.marginBottom = '5px';

            // é€²åº¦æ¢
            const progressBar = document.createElement('div');
            progressBar.style.height = "8px";
            progressBar.style.width = "0%";
            progressBar.style.background = "#4caf50";
            progressBar.style.borderRadius = "4px";
            progressBar.style.transition = "width 0.3s";

            bubble.appendChild(progressText);
            bubble.appendChild(progressBar);

            contentEl.appendChild(usernameEl);
            contentEl.appendChild(bubble);
            msgEl.appendChild(avatar);
            msgEl.appendChild(contentEl);

            messagesDiv.appendChild(msgEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // å›å‚³å…©å€‹å…ƒç´ æ–¹ä¾¿ä¸Šå‚³äº‹ä»¶æ›´æ–°
            return { progressBar, progressText };
        }
        

        // === ä¸Šå‚³åœ–ç‰‡ ===
        uploadImageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // ä¸Šå‚³å¾Œä¸ç”¨ pushï¼Œç­‰ sendPost() å‘¼å«æ™‚å†é€
        });

        // === ä¸Šå‚³å½±ç‰‡ === 
        uploadVideoBtn.addEventListener('click', () => videoInput.click());
        videoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // ä¸Šå‚³å¾Œä¸ç”¨ pushï¼Œç­‰ sendPost() å‘¼å«æ™‚å†é€
        });

        // === ç™¼ä½ˆæ´»å‹• ===
        eventDate.addEventListener('input', updatePreview);
        eventTime.addEventListener('input', updatePreview);
        eventLocation.addEventListener('input', updatePreview);
        createEventBtn.addEventListener('click', () => {
            eventForm.style.display = eventForm.style.display === 'none' ? 'block' : 'none';
        });

        sendEventBtn.addEventListener('click', () => {
            const date = eventDate.value.trim();
            const time = eventTime.value.trim();
            const location = eventLocation.value.trim();

            if (!date || !time || !location) {
                alert("è«‹å¡«å¯«å®Œæ•´çš„æ´»å‹•è³‡è¨Šï¼");
                return;
            }

            push(messagesRef, {
                user: "ç®¡ç†å“¡",
                type: "event",
                date,
                time,
                location,
                participants: 0,
                timestamp: Date.now()
            });

            // æ¸…ç©ºè¡¨å–®ä¸¦éš±è—
            eventDate.value = '';
            eventTime.value = '';
            eventLocation.value = '';
            eventForm.style.display = 'none';
            previewDiv.innerHTML = '';
        });


        // === é è¦½å€ ===
        messageInput.addEventListener('input', updatePreview);
        imageInput.addEventListener('change', updatePreview);
        videoInput.addEventListener('change', updatePreview);
        function updatePreview() {
            previewDiv.innerHTML = ''; 
            let hasContent = false;

            // æ–‡å­—
            if (messageInput.value.trim()) {
                const textEl = document.createElement('p');
                textEl.innerHTML = messageInput.value.trim().replace(/\n/g, '<br>');
                previewDiv.appendChild(textEl);
                hasContent = true;
            }

            // åœ–ç‰‡
            if (imageInput.files[0]) {
                const imgEl = document.createElement('img');
                imgEl.src = URL.createObjectURL(imageInput.files[0]);
                imgEl.className = 'upload-preview';
                previewDiv.appendChild(imgEl);
                hasContent = true;
            }

            // å½±ç‰‡
            if (videoInput.files[0]) {
                const videoEl = document.createElement('video');
                videoEl.src = URL.createObjectURL(videoInput.files[0]);
                videoEl.controls = true;
                videoEl.style.maxHeight = "200px";
                previewDiv.appendChild(videoEl);
                hasContent = true;
            }

            // æ´»å‹•é è¦½
            if (eventDate.value.trim() || eventTime.value.trim() || eventLocation.value.trim()) {
                const eventPreview = document.createElement('div');
                eventPreview.className = 'event-bubble';
                eventPreview.innerHTML = `
                    <div class="event-title">ğŸ¾ æ´»å‹•é è¦½</div>
                    <div class="event-info">
                        ğŸ“… æ—¥æœŸ: ${eventDate.value || '-'}<br>
                        ğŸ•’ æ™‚é–“: ${eventTime.value || '-'}<br>
                        ğŸ“ åœ°é»: ${eventLocation.value || '-'}
                    </div>
                `;
                previewDiv.appendChild(eventPreview);
                hasContent = true;
            }

            // åªæœ‰æœ‰å…§å®¹æ‰é¡¯ç¤º
            previewDiv.style.display = hasContent ? 'block' : 'none';
        }

        // === ç™¼é€è¨Šæ¯çµ±ä¸€æ–¹æ³• ===
        function sendMessage(data) {
            const user = "ç®¡ç†å“¡"; // å›ºå®šç®¡ç†å“¡
            push(messagesRef, { user, ...data, timestamp: Date.now() });
        }
    </script>
</body>
</html>
