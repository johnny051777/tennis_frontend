<!--http://127.0.0.1:8000/serve_practiceï¼ˆç™¼çƒç·´ç¿’é é¢ï¼‰-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>ç™¼çƒç·´ç¿’ç´€éŒ„</title>

    <!-- ğŸ“Š åœ–è¡¨æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ğŸ¨ å…¨åŸŸæ¨£å¼èˆ‡ Reset -->
    <style>
        :root {
            --navbar-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Noto Sans TC", sans-serif;
            background: #f2f2f2;
            margin: 10px;
            padding: 0px 0px;
        }
    </style>

    <!--  å°è¦½åˆ—æ¨£å¼ -->
    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
        }

        .navbar .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar a {
            text-decoration: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>

    <!--  è¡¨æ ¼æ¨£å¼ -->
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 30px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #ddd;
        }
    </style>

    <!-- ğŸ“Š åœ–è¡¨å€å¡Š -->
    <style>
        .charts {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        .charts > div {
            background: #f5f5f5;      /* èƒŒæ™¯ç°ç™½ä¸€é»ï¼Œé¿å…å¤ªæ·± */
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        canvas {
            max-width: 400px;
            margin-top: 30px;
        }
    </style>

    <!--  èƒŒæ™¯å‹•ç•«åœ“å½¢ -->
    <style>
        .content {
            margin-top: calc(var(--navbar-height) + 20px);
            padding: 0px 0px;
            position: relative;
            background: radial-gradient(circle at center, #eaffea 0%, #ffffff 100%);
            overflow: hidden;
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }

        .circle.green {
            background-color: #A5D6A7;
        }

        .circle.white {
            background-color: #F1F8E9;
        }

        .circle1 {
            width: 120px;
            height: 120px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .circle2 {
            width: 200px;
            height: 200px;
            top: 60%;
            left: 70%;
            animation-delay: 2s;
        }

        .circle3 {
            width: 80px;
            height: 80px;
            top: 40%;
            left: 50%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(360deg);
            }
        }

        .main-content {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">ç¶²çƒåŠ©æ‰‹</div>
        <div class="nav-links">
            <a href="index">é¦–é </a>
            <a href="rules">è¦å‰‡è§£èªª</a>
            <a href="score">è¨˜åˆ†æ¿</a>
            <a href="videos">å½±ç‰‡è§£èªª</a>
            <a href="wall_training">å°ç‰†ç·´ç¿’</a>
            <a href="serve_practice">ç™¼çƒç·´ç¿’</a>
            <a href="swing_practice">æ®æ‹ç·´ç¿’</a>
            <a href="throwing_practice">æ‹‹çƒç·´ç¿’</a>
            <a href="chatroom">èŠå¤©å®¤</a>
        </div>
    </div>
    <div class="content">
            <!-- å‹•æ…‹èƒŒæ™¯åœ“å½¢ -->
        <div class="circle green circle1"></div>
        <div class="circle white circle2"></div>
        <div class="circle green circle3"></div>
        <div class="main-content">
            <h1>ğŸ¾ ç™¼çƒç·´ç¿’ç´€éŒ„</h1>
            <p>ä»¥ä¸‹æ˜¯æœ€è¿‘çš„ç™¼çƒç·´ç¿’ç´€éŒ„ï¼ŒåŒ…å«å§¿å‹¢æé†’èˆ‡è½é»åˆ†æ</p>
            <div class="charts">
                <!-- åœ“é¤…åœ– -->
                <div>
                    <h2>ç™¼çƒæˆåŠŸæ¯”ä¾‹</h2>
                    <canvas id="successChart"></canvas>
                </div>
                <!-- æˆåŠŸé«˜åº¦åˆ†æ -->
                <div>
                    <h2>æˆåŠŸç™¼çƒçš„æ‹‹çƒé«˜åº¦</h2>
                    <canvas id="heightChart"></canvas>
                </div>
                <!-- å¹³å‡è½é» -->
                <div>
                    <h2>æˆåŠŸç™¼çƒçš„è½é»ä½ç½®åˆ†å¸ƒ</h2>
                    <canvas id="positionChart" width="250" height="300" style="max-width: 100%; height: auto;"></canvas>
                </div>
            </div>
            <h2>ç³»çµ±ç¸½çµè©•èª</h2>
            <p>
                {% set comments = {} %}
                {% set counts = namespace(elbow_error=0, waist_error=0, hand_foot_error=0) %}
                {% set total_records = data.records | length %}

                {% for record in data.records %}
                    <!--<p>æ‰‹è‚˜è§’åº¦: {{ record.posture_reminder.swing_posture.elbow_straight }}</p>
                    <p>è…°éƒ¨è§’åº¦: {{ record.posture_reminder.swing_posture.waist_straight }}</p>-->
                    {% set elbow_ok = 167 <= record.posture_reminder.swing_posture.elbow_straight <= 173 %}
                    {% set waist_ok = record.posture_reminder.swing_posture.waist_straight > 40 %}
                    {% set hand_foot_ok = record.posture_reminder.dominant_hand_and_foot.dominant_hand == 'right' and record.posture_reminder.dominant_hand_and_foot.front_foot == 'left' %}

                    {% if not elbow_ok %}
                        {% set counts.elbow_error = counts.elbow_error + 1 %}
                    {% endif %}

                    {% if not waist_ok %}
                        {% set counts.waist_error = counts.waist_error + 1 %}
                    {% endif %}

                    {% if not hand_foot_ok %}
                        {% set counts.hand_foot_error = counts.hand_foot_error + 1 %}
                    {% endif %}

                    {% if elbow_ok and waist_ok and record.landing_analysis.serve_successful %}
                        {% set comment = "å§¿å‹¢ç©©å®šï¼Œç™¼çƒæˆåŠŸï¼Œè¡¨ç¾è‰¯å¥½ã€‚" %}
                    {% elif (elbow_ok or waist_ok) and record.landing_analysis.serve_successful %}
                        {% set comment = "å§¿å‹¢éœ€å¾®èª¿ï¼Œä½†æˆåŠŸç‡é‚„ä¸éŒ¯ã€‚" %}
                    {% elif elbow_ok and waist_ok %}
                        {% set comment = "å§¿å‹¢ä¸éŒ¯ä½†æº–ç¢ºç‡éœ€åŠ å¼·ã€‚" %}
                    {% else %}
                        {% set comment = "å§¿å‹¢éœ€è¦å†èª¿æ•´ã€‚" %}
                    {% endif %}

                    {% set _ = comments.update({comment: comments.get(comment, 0) + 1}) %}
                {% endfor %}

                {% set most_common = comments | dictsort(true, 'value') | first %}
                {% if most_common %}
                    <strong>{{ most_common[0] }}</strong>
                {% else %}
                    <strong>æ²’æœ‰æ•¸æ“š</strong>
                {% endif %}
                <p>æ‰‹è‚˜éŒ¯èª¤æ¬¡æ•¸ï¼š{{ counts.elbow_error }} / {{ total_records }}</p>
                <p>è…°éƒ¨éŒ¯èª¤æ¬¡æ•¸ï¼š{{ counts.waist_error }} / {{ total_records }}</p>
                <p>æ‰‹è…³éŒ¯èª¤æ¬¡æ•¸ï¼š{{ counts.hand_foot_error }} / {{ total_records }}</p>
            </p>

            <h3>å»ºè­°ï¼š</h3>
            <ul>
                {% if total_records > 0 and (counts.elbow_error / total_records) > 0.4 %}
                    <li>æ‹‹çƒæ™‚ï¼Œæ‰‹è‚˜éœ€å†å¤šä¼¸ç›´ã€‚</li>
                {% endif %}
                {% if total_records > 0 and counts.waist_error / total_records > 0.4 %}
                    <li>æ“Šçƒæ™‚éœ€å¤šè½‰å‹•è…°éƒ¨ï¼Œå¦å‰‡å¯èƒ½æœƒé€ æˆæ‰‹è…•æˆ–è‚©è†€å—å‚·ã€‚</li>
                {% endif %}
                {% if total_records > 0 and counts.hand_foot_error / total_records > 0.4 %}
                    <li>é å‚™å‹•ä½œï¼Œè«‹ç¶­æŒå·¦è…³åœ¨å‰ï¼Œå³è…³åœ¨å¾Œï¼Œç­‰å¾…æ“Šçƒã€‚</li>
                {% endif %}

                {% if total_records > 0 and counts.elbow_error / total_records <= 0.4 
                    and counts.waist_error / total_records <= 0.4 
                    and counts.hand_foot_error / total_records <= 0.4 %}
                    <li>ç›®å‰æ²’æœ‰ç‰¹åˆ¥éœ€è¦èª¿æ•´çš„å»ºè­°ï¼Œè«‹æŒçºŒä¿æŒï¼</li>
                {% endif %}
            </ul>
            <!-- è¡¨æ ¼ -->
            <h2>è©³ç´°ç´€éŒ„</h2>
            <table>
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>æ‹‹çƒé«˜åº¦</th>
                        <th>çƒä½ç½® (x, y, z)</th>
                        <th>æ‰‹è‚˜è§’åº¦ (æ­£ç¢ºç¯„åœ 167Â°~173Â°)</th>
                        <th>è…°éƒ¨è§’åº¦ (>40Â°)</th>
                        <th>æ…£ç”¨æ‰‹/å‰è…³</th>
                        <th>ç™¼çƒæˆåŠŸ</th>
                        <th>è½é»åº§æ¨™</th>
                        <th>æŸ¥çœ‹ä½ç½®</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in data.records %}
                    {% set elbow_angle = record.posture_reminder.swing_posture.elbow_straight %}
                    {% set waist_angle = record.posture_reminder.swing_posture.waist_straight %}
                    {% set elbow_ok = 167 <= elbow_angle <= 173 %}
                    {% set waist_ok = waist_angle > 40 %}
                    <tr>
                        <td>{{ record.timestamp }}</td>
                        <td>{{ record.ball.target_height }}</td>
                        <td>({{ record.ball.current_position.x }}, {{ record.ball.current_position.y }}, {{ record.ball.current_position.z }})</td>
                        
                        <td>
                            {{ elbow_angle }}Â°
                            {{ 'âœ”ï¸' if elbow_ok else 'âŒ' }}
                        </td>
                        <td>
                            {{ waist_angle }}Â°
                            {{ 'âœ”ï¸' if waist_ok else 'âŒ' }}
                        </td>
                        <td>{{ record.posture_reminder.dominant_hand_and_foot.dominant_hand }}/{{ record.posture_reminder.dominant_hand_and_foot.front_foot }}</td>
                        <!-- ç™¼çƒæˆåŠŸèˆ‡å¦ -->
                        <td>
                            {% if record.landing_analysis.serve_successful %}
                                <span style="color: green;">âœ”ï¸ æˆåŠŸ</span>
                            {% else %}
                                <span style="color: red;">âŒ å¤±æ•—</span>
                            {% endif %}
                        </td>
                        <td>({{ record.landing_analysis.court_position.x }}, {{ record.landing_analysis.court_position.y }})</td>
                        <td> 
                            <button class="highlight-btn">check</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
    </div>
    <!-- JSON è³‡æ–™ -->
    <script id="serve-data" type="application/json">
        {{ data.records | tojson }}
    </script>
    <!--ç”¨ Chart.js annotation æ’ä»¶ç•«ç·š (è‡ªè¨‚é‚Šç·šã€ç™¼çƒç·š)-->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <!-- Chart JS -->
    <script >
        const serveData = JSON.parse(document.getElementById("serve-data").textContent);
        
        // ç™¼çƒæˆåŠŸèˆ‡å¤±æ•—åœ“é¤…åœ–
        const successCount = serveData.filter(r => r.landing_analysis.serve_successful).length;
        const failCount = serveData.length - successCount;

        new Chart(document.getElementById('successChart'), {
            type: 'pie',
            data: {
                labels: ['æˆåŠŸ', 'å¤±æ•—'],
                datasets: [{
                    data: [successCount, failCount],
                    backgroundColor: ['#4CAF50', '#F44336']
                }]
            },
            options: {
                responsive: true
            }
        });

        // æˆåŠŸç™¼çƒæ‹‹çƒé«˜åº¦çš„æ£’ç‹€åœ–
        const successfulHeights = serveData
            .filter(r => r.landing_analysis.serve_successful)
            .map((r, idx) => ({ index: idx + 1, height: r.ball.target_height }));

        new Chart(document.getElementById('heightChart'), {
            type: 'bar',
            data: {
                labels: successfulHeights.map(h => `#${h.index}`),
                datasets: [{
                    label: 'æ‹‹çƒé«˜åº¦ (å…¬å°º)',
                    data: successfulHeights.map(h => h.height),
                    backgroundColor: '#2196F3'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // æˆåŠŸè½é»çš„æ•£é»åœ–
        const successPositions = serveData
            .filter(r => r.landing_analysis.serve_successful)
            .map(r => ({
                x: r.landing_analysis.court_position.x,
                y: r.landing_analysis.court_position.y
            }));

        const failPositions = serveData
            .filter(r => !r.landing_analysis.serve_successful)
            .map(r => ({
                x: r.landing_analysis.court_position.x,
                y: r.landing_analysis.court_position.y
            }));

        new Chart(document.getElementById('positionChart'), {
            type: 'scatter',
            data: {
                datasets: 
                [
                    {
                        label: 'æˆåŠŸè½é»ä½ç½®',
                        data: successPositions,
                        backgroundColor: '#4CAF50' // ç¶ è‰²
                    },
                    {
                        label: 'å¤±æ•—è½é»ä½ç½®',
                        data: failPositions,
                        backgroundColor: '#F44336' // ç´…è‰²
                    }
                ]
            },
            options: {
                // é—œé–‰è‡ªé©æ‡‰ï¼Œæ‰èƒ½å›ºå®šcanvaså¯¬é«˜
                responsive: false,
                // è®“è¨­å®šçš„å¯¬é«˜ç”Ÿæ•ˆ
                maintainAspectRatio: false,  
                scales: {
                    x: {
                        title: { display: true, text: 'X ä½ç½® (må…¬å°º)' },
                        min: 0,
                        max: 10.97
                    },
                    y: {
                        title: { display: true, text: 'Y ä½ç½® (må…¬å°º)' },
                        min: 0,
                        max: 23.78
                    }
                },
                plugins: {
                    legend: {
                        display: false  // é—œé–‰åœ–ä¾‹
                        //fillStyle: '#FF9800',  // ç„¡æ³•å›ºå®šé¡è‰²
                    },
                    annotation: {
                        annotations: {
                            // ä»¥ä¸‹å–®ä½ m
                            // å·¦é‚Šç•Œ
                            leftLine: {
                                type: 'line',
                                xMin: 0,
                                xMax: 0,
                                yMin: 0,
                                yMax: 23.78,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            //å·¦å…§ç•Œ
                            leftsinglessideline: {
                                type: 'line',
                                xMin: 1.37,
                                xMax: 1.37,
                                yMin: 0,
                                yMax: 23.78,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            // å³é‚Šç•Œ
                            rightLine: {
                                type: 'line',
                                xMin: 10.97,
                                xMax: 10.97,
                                yMin: 0,
                                yMax: 23.78,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            //å³å…§ç•Œ
                            rightsinglessideline: {
                                type: 'line',
                                xMin: 9.6,
                                xMax: 9.6,
                                yMin: 0,
                                yMax: 23.78,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            // ç™¼çƒç·š (ä¸­å¤®)
                            serviceLine: {
                                type: 'line',
                                xMin: 1.37,
                                xMax: 9.6,
                                yMin: 5.49,
                                yMax: 5.49,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            // ç™¼çƒç·š (ä¸­å¤®)
                            serviceLine2: {
                                type: 'line',
                                xMin: 1.37,
                                xMax: 9.6,
                                yMin: 18.29,
                                yMax: 18.29,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            // ä¸­å¤®ç·š
                            centerServiceLine: {
                                type: 'line',
                                xMin: 5.485,
                                xMax: 5.485,
                                yMin: 5.49,
                                yMax: 18.29,
                                borderColor: 'black',
                                borderWidth: 2,
                            },
                            // åº•ç·š
                            baseline: {
                                type: 'line',
                                xMin: 0,
                                xMax: 10.97,
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            //é ‚ç·š
                            topline:{
                                type: 'line',
                                xMin: 0,
                                xMax: 10.97,
                                yMin: 23.78,
                                yMax: 23.78,
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            //ç¶²å­
                            net:{
                                type: 'line',
                                xMin: 0,
                                xMax: 10.97,
                                yMin: 11.89,
                                yMax: 11.89,
                                borderColor: 'black',
                                borderWidth: 2
                            }
                            //
                        }
                    }
                }
            }
        });
        
    </script>
    <!--é¡¯ç¤ºç™¼çƒé»å‹•ç•«-->
    <script>
        const positionChartCanvas = document.getElementById('positionChart');
        const positionChartInstance = Chart.getChart(positionChartCanvas);

        const defaultColors = positionChartInstance.data.datasets[0].data.map(() => '#FF9800');
        positionChartInstance.data.datasets[0].pointBackgroundColor = [...defaultColors];
        positionChartInstance.update();

        let flashInterval = null;  // è¨˜éŒ„å‹•ç•«ç”¨

        document.querySelectorAll('.highlight-btn').forEach((btn, index) => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();

                // æ¸…é™¤ä¸Šä¸€æ¬¡çš„é–ƒçˆ
                clearInterval(flashInterval);
                positionChartInstance.data.datasets[0].pointBackgroundColor = [...defaultColors];
                positionChartInstance.update();

                const chartIndex = getChartPointIndex(index);
                if (chartIndex !== -1) {
                    let isRed = false;
                    flashInterval = setInterval(() => {
                        positionChartInstance.data.datasets[0].pointBackgroundColor[chartIndex] = isRed ? '#FF9800' : '#4CAF50';//ç¶ è‰²
                        positionChartInstance.update('none');  // ç„¡å‹•ç•«æ›´æ–°
                        isRed = !isRed;
                    }, 500);  // æ¯ 0.5 ç§’åˆ‡æ›
                }
            });
        });

        function getChartPointIndex(rowIndex) {
            let successfulIndexes = [];
            serveData.forEach((record, idx) => {
                if (record.landing_analysis.serve_successful) {
                    successfulIndexes.push(idx);
                }
            });
            return successfulIndexes.indexOf(rowIndex);
        }
    </script>

</body>
</html>
