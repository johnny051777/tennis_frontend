<!--http://127.0.0.1:8000/wall_trainingï¼ˆå°ç‰†ç·´ç¿’é é¢ï¼‰-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>å°ç‰†ç·´ç¿’ç´€éŒ„</title>
    <!-- ğŸ“Š åœ–è¡¨æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <!--  å…¨åŸŸæ¨£å¼èˆ‡ Reset -->
    <style>
        :root {
            --navbar-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Sans TC", "Segoe UI", sans-serif;
            background: #f2f2f2;
            margin: 0;
        }

        h1, h2 {
            color: #333;
        }

        p {
            font-size: 1.1em;
            color: #444;
            margin-bottom: 10px;
        }
    </style>

    <!-- å°è¦½åˆ—æ¨£å¼ -->
    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
        }

        .navbar .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
        }

        .navbar a {
            text-decoration: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-links a:hover {
            color: #4CAF50;
        }
    </style>

    <!-- å…§å®¹å€åŸŸæ¨£å¼ -->
    <style>
        .content {
            margin-top: calc(var(--navbar-height) + 20px);
            padding: 60px 20px;
            position: relative;
            background: radial-gradient(circle at center, #eaffea 0%, #ffffff 100%);
            overflow: hidden;
        }

        .main-content {
            position: relative;
            z-index: 1;
        }
    </style>

    <!-- å‹•æ…‹èƒŒæ™¯åœ“å½¢ -->
    <style>
        .circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
            z-index: 0;
        }

        .circle.green {
            background-color: #A5D6A7;
        }

        .circle.white {
            background-color: #F1F8E9;
        }

        .circle.deepgreen{
            background-color: #17761a;
        }

        .circle1 {
            width: 120px;
            height: 120px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .circle2 {
            width: 200px;
            height: 200px;
            top: 60%;
            left: 70%;
            animation-delay: 2s;
        }

        .circle3 {
            width: 80px;
            height: 80px;
            top: 40%;
            left: 50%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(360deg);
            }
        }
    </style>

    <!-- åœ–è¡¨å€æ¨£å¼ -->
    <style>
        .charts {
            display: flex;
            flex-wrap: nowrap;/* ä¸å…è¨±æ›è¡Œ */
            gap: 30px;
            /*justify-content: center;*/ /* è®“è£¡é¢çš„åœ–è¡¨é ä¸­ */
        }
        .charts > div {
            background: #f5f5f5;      /* èƒŒæ™¯ç°ç™½ä¸€é»ï¼Œé¿å…å¤ªæ·± */
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        canvas {
            max-width: 400px;
            margin-top: 30px;
        }
    </style>

    <style>
        .coach { 
            background: #d4d4d4; 
            border-radius: 12px; 
            padding: 12px 14px; 
            box-shadow: 0 2px 10px rgba(0,0,0,.06); 
            margin-top: 14px; 
        }
        .coach h3 { font-size: 16px; margin-bottom: 6px; }
        .coach ul { padding-left: 18px; }
        .coach li { margin: 4px 0; }
    </style>
    <!-- ğŸ¯ è½é»åœ–å€ -->
    <style>
        #score-zone {
            width: 400px;
            height: 400px;
            background-color: white;
            border: 2px solid #ccc;
            position: relative;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #score-square {
            position: absolute;
            border: 2px dashed #4CAF50;
            background: rgba(76, 175, 80, 0.3);
            box-sizing: border-box;
        }

        .ball-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #4CAF50;
            opacity: 0.8;
            transition: transform 0.2s;
        }

        .ball-dot:hover {
            transform: scale(1.8);
            z-index: 10;
        }

        .ball-dot.out {
            background-color: #F44336;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">ç¶²çƒåŠ©æ‰‹</div>
        <div class="nav-links">
            <a href="index">é¦–é </a>
            <a href="rules">è¦å‰‡è§£èªª</a>
            <a href="score">è¨˜åˆ†æ¿</a>
            <a href="videos">å½±ç‰‡è§£èªª</a>
            <a href="wall_training">å°ç‰†ç·´ç¿’</a>
            <a href="serve_practice">ç™¼çƒç·´ç¿’</a>
            <a href="swing_practice">æ®æ‹ç·´ç¿’</a>
            <a href="throwing_practice">æ‹‹çƒç·´ç¿’</a>
            <a href="chatroom">èŠå¤©å®¤</a>
        </div>
    </div>
    <div class="content">
        <!-- å‹•æ…‹èƒŒæ™¯åœ“å½¢ -->
        <div class="circle green circle1"></div>
        <div class="circle deepgreen circle2"></div>
        <div class="circle green circle3"></div>
        <div class="main-content">
            <h1>ğŸ¾ å°ç‰†ç·´ç¿’ç´€éŒ„</h1>
            <p>æœ¬æ¬¡ç·´ç¿’æ™‚é–“ï¼š{{ data.summary.duration_sec }} ç§’</p>
            <p>ç¸½æ“Šçƒæ•¸ï¼š{{ data.summary.total_hits }} çƒ</p>
            <p>å¾—åˆ†å€å¤§å°ï¼š{{ data.summary.score_zone_size_cm }} cm Ã— {{ data.summary.score_zone_size_cm }} cm</p>
            <p>è½åœ¨å¾—åˆ†å€å…§ï¼š{{ data.summary.in_score_zone }} çƒ</p>
            <p>è½åœ¨å¾—åˆ†å€å¤–ï¼š{{ data.summary.out_score_zone }} çƒ</p>

            <div class="charts">
                <div>
                    <h2>è½é»åˆ†å¸ƒåœ“é¤…åœ–</h2>
                    <canvas id="pieChart"></canvas>
                </div>
                <div>
                    <h2>æ¯åˆ†é˜æ“Šçƒæ•¸</h2>
                    <canvas id="hitsChart"></canvas>
                </div>
            </div>

            <div class="coach" id="coach-panel" style="display:none;">
                <h3>ğŸ“Œ è‡ªå‹•åˆ†æèˆ‡å»ºè­°</h3>
                <ul id="coach-list"></ul>
            </div>

            <h2>ç‰†å£ä¸Šçš„è½é»ç¤ºæ„åœ–</h2>
            <div id="score-zone">
                <div id="score-square"></div>
            </div>
        </div>
    </div>
    
    <script id="wall-data" type="application/json">
        {{ data.records | tojson }}
    </script>

    <script id="wall-summary" type="application/json">
        {{ data.summary | tojson }}
    </script>

    <script>
        // è§£æè³‡æ–™
        const data = JSON.parse(document.getElementById("wall-data").textContent);
        const summary = JSON.parse(document.getElementById("wall-summary").textContent);

        // å¾—åˆ†å€åœ¨ç‰†ä¸Šçš„å¤§å°ï¼ˆæ¯”ä¾‹æ˜ å°„åˆ° 400x400 pxï¼‰
        const wallWidthPx = 400;
        const wallHeightPx = 400;

        // === ç‰†é¢å€åŸŸï¼šå–å¾—å¯¦éš›å¯¬é«˜ï¼ˆcv2 åº§æ¨™ç³»ï¼‰ ===
        const wallTopLeft = summary.wall_area.corner_1;  // å‡è¨­ corner_1 æ˜¯ top-left
        const wallBottomRight = summary.wall_area.corner_2; // å‡è¨­ corner_3 æ˜¯ bottom-right

        const wallWidth = Math.abs(wallBottomRight.x - wallTopLeft.x);
        const wallHeight = Math.abs(wallBottomRight.y - wallTopLeft.y);

        // === å¾—åˆ†å€ä½ç½®æ›ç®—æˆ 400x400 å€åŸŸçš„ç›¸å°ä½ç½® ===
        const topLeft = {
            x: (summary.score_zone.top_left.x - wallTopLeft.x) / wallWidth * wallWidthPx,
            y: (summary.score_zone.top_left.y - wallTopLeft.y) / wallHeight * wallHeightPx
        };
        const bottomRight = {
            x: (summary.score_zone.bottom_right.x - wallTopLeft.x) / wallWidth * wallWidthPx,
            y: (summary.score_zone.bottom_right.y - wallTopLeft.y) / wallHeight * wallHeightPx
        };

        // ç•«å‡ºå¾—åˆ†å€
        const width = Math.abs(bottomRight.x - topLeft.x);
        const height = Math.abs(bottomRight.y - topLeft.y);

        const scoreSquare = document.getElementById("score-square");
        scoreSquare.style.position = "absolute";
        scoreSquare.style.left = topLeft.x + "px";
        scoreSquare.style.top = topLeft.y + "px";
        scoreSquare.style.width = width + "px";
        scoreSquare.style.height = height + "px";

        // é¡¯ç¤ºçƒé»ï¼ˆåŒæ¨£ä»¥ç‰†é¢å€åŸŸç‚ºåƒè€ƒï¼‰
        const scoreZone = document.getElementById("score-zone");

        data.forEach(ball => {
            const dot = document.createElement("div");
            dot.classList.add("ball-dot");
            if (!ball.in_score_zone) dot.classList.add("out");

            // å°‡ ball åº§æ¨™æ›ç®—ç‚ºç›¸å°ç‰†é¢æ¯”ä¾‹ï¼Œå†æ˜ å°„åˆ° 400x400
            dot.style.left = ((ball.ball_position.x - wallTopLeft.x) / wallWidth * wallWidthPx - 3) + "px";
            dot.style.top = ((ball.ball_position.y - wallTopLeft.y) / wallHeight * wallHeightPx - 3) + "px";

            scoreZone.appendChild(dot);
        });

        // è½é»åœ“é¤…åœ–
        const inZoneCount = summary.in_score_zone;
        const outZoneCount = summary.out_score_zone;

        new Chart(document.getElementById("pieChart"), {
            type: "pie",
            data: {
                labels: ["å¾—åˆ†å€å…§", "å¾—åˆ†å€å¤–"],
                datasets: [{
                    data: [inZoneCount, outZoneCount],
                    backgroundColor: ["#4CAF50", "#F44336"]
                }]
            },
            options: {
                responsive: true
            }
        });

        // è¨ˆæ™‚å…§æ“Šçƒæ•¸æ£’ç‹€åœ– (æ¨¡æ“¬ 6 å€‹ 10 ç§’å€é–“æ“Šçƒæ•¸)
        // å…ˆå°‡çƒä¾æ™‚é–“åˆ†å€é–“
        const duration = summary.duration_sec;
        const intervals = 6;
        const intervalLength = duration / intervals;

        // å°‡æ“Šçƒä¾æ™‚é–“åˆ†é¡
        const hitsPerInterval = Array(intervals).fill(0);
        const startTime = new Date(data[0]?.timestamp || Date.now());

        data.forEach(ball => {
            const t = new Date(ball.timestamp);
            const diffSec = (t - startTime) / 1000;
            const idx = Math.min(Math.floor(diffSec / intervalLength), intervals - 1);
            hitsPerInterval[idx]++;
        });

        const hitsCtx = document.getElementById("hitsChart").getContext("2d");
        new Chart(hitsCtx, {
            type: "bar",
            data: {
                labels: Array.from({length: intervals}, (_, i) => `${Math.floor(i*intervalLength)}-${Math.floor((i+1)*intervalLength)}ç§’`),
                datasets: [{
                    label: "æ“Šçƒæ•¸",
                    data: hitsPerInterval,
                    backgroundColor: "#2196F3"
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } }
            }
        });
    </script>

    <!-- æ“Šçƒè©•ä¼°å»ºè­° -->
    <script>
        // === å„ªåŒ–æ•™ç·´å»ºè­°ç”Ÿæˆ ===
        const coachPanel = document.getElementById("coach-panel");
        const coachList = document.getElementById("coach-list");
        coachList.innerHTML = ""; // æ¸…ç©ºåŸæœ‰

        const totalHits = hitsPerInterval.reduce((a,b)=>a+b,0);
        const percentPerInterval = hitsPerInterval.map(h => h / totalHits);

        // è¨ˆç®—ç©©å®šåº¦ï¼šæ¨™æº–å·® / å¹³å‡
        const meanHits = totalHits / intervals;
        const variance = hitsPerInterval.reduce((sum, h) => sum + Math.pow(h - meanHits, 2), 0) / intervals;
        const stdDev = Math.sqrt(variance);
        const stability = 1 - stdDev / (meanHits || 1); // è¶Šæ¥è¿‘ 1 è¶Šç©©å®š

        let suggestions = [];

        // 1ï¸âƒ£ å‰ä¸­å¾Œå€æ®µåˆ†æ
        const maxIdx = percentPerInterval.indexOf(Math.max(...percentPerInterval));
        if(maxIdx === 0){
            suggestions.push("çƒé›†ä¸­åœ¨ç·´ç¿’å‰æ®µï¼Œå»ºè­°åŠ å¼·ç©©å®šåº¦èˆ‡æŒçºŒåŠ›ã€‚");
        }else if(maxIdx === intervals-1){
            suggestions.push("çƒé›†ä¸­åœ¨ç·´ç¿’å¾Œæ®µï¼Œæ³¨æ„èµ·å§‹éšæ®µçš„æº–å‚™èˆ‡åæ‡‰é€Ÿåº¦ã€‚");
        }else{
            suggestions.push("çƒé›†ä¸­åœ¨ä¸­æ®µï¼Œä¿æŒè‰¯å¥½ç¯€å¥ï¼Œä½†æ³¨æ„å‰å¾Œç©©å®šåº¦ã€‚");
        }

        // 2ï¸âƒ£ ç©©å®šåº¦åˆ†æ
        if(stability < 0.7){
            suggestions.push("æ“Šçƒåˆ†å¸ƒä¸å‡ï¼Œç©©å®šåº¦è¼ƒä½ï¼Œå»ºè­°æ…¢ä¸‹ç¯€å¥ä¸¦ä¿æŒä¸€è‡´æ“Šçƒã€‚");
        }else{
            suggestions.push("æ“Šçƒç©©å®šåº¦è‰¯å¥½ï¼ŒæŒçºŒä¿æŒã€‚");
        }

        // 3ï¸âƒ£ ç¯€å¥åˆ†æ
        const maxPercent = Math.max(...percentPerInterval);
        const minPercent = Math.min(...percentPerInterval);
        if(maxPercent - minPercent > 0.3){
            suggestions.push("æ“Šçƒç¯€å¥ä¸å‡ï¼Œæ³¨æ„ç¶­æŒå‡å‹»æ“Šçƒé€Ÿåº¦ã€‚");
        }

        // 4ï¸âƒ£ ç¸½æ“Šçƒæ•¸æª¢æŸ¥
        if(totalHits < 10){
            suggestions.push("ç¸½æ“Šçƒæ•¸è¼ƒå°‘ï¼Œå»ºè­°å»¶é•·ç·´ç¿’æ™‚é–“ä»¥å¢åŠ ç·´ç¿’é‡ã€‚");
        }

        // 5ï¸âƒ£ å‘½ä¸­ç‡è¶¨å‹¢åˆ†æï¼ˆéœ€è¦æ¯å€‹å€é–“ in_score_zone æ•¸æ“šï¼Œå¯é¸ï¼‰
        if(summary.hits_in_score_zone_per_interval){
            const hitsInZone = summary.hits_in_score_zone_per_interval;
            const rateDecline = hitsInZone[0] > hitsInZone[intervals-1];
            if(rateDecline){
                suggestions.push("ç·´ç¿’å¾Œæ®µå‘½ä¸­ç‡ä¸‹é™ï¼Œæ³¨æ„é«”èƒ½èˆ‡é›†ä¸­åŠ›ã€‚");
            }
        }

        // å°‡å»ºè­°å¯«å…¥åˆ—è¡¨
        if(suggestions.length === 0){
            suggestions.push("æ“Šçƒåˆ†å¸ƒå‡å‹»ï¼Œç©©å®šåº¦è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼");
        }

        suggestions.forEach(text => {
            const li = document.createElement("li");
            li.textContent = text;
            coachList.appendChild(li);
        });

        coachPanel.style.display = "block"; // é¡¯ç¤ºæ•™ç·´å»ºè­°

    </script>
</body>
</html>
